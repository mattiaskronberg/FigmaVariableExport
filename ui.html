<head>

  <style>
    .checkboxes {
      display: inline-block;
    }

    .colCheckbox {
      border-radius: 15%;
    }
  </style>
</head>
<h2>Export .scheme</h2>
<div id="checkboxContainer">

</div>
<button id="export">Export</button>
<script>


  onmessage = async (event) => {

    const { type, data } = event.data.pluginMessage;

    switch (type) {
      case "variableCollectionsFound":
        console.log("Variable collection found. Count:", data.length);

        const container = document.getElementById('checkboxContainer');
        container.innerHTML = '';

        data.forEach(collection => {
          console.log(collection);
          const label = document.createElement('label');
          label.className = "checkboxes";
          const checkbox = document.createElement('input');
          checkbox.type = 'radio';
          checkbox.name = 'collection';
          checkbox.className = 'colCheckbox';
          checkbox.value = collection.id;
          label.appendChild(checkbox);
          label.append(collection.name);
          container.appendChild(label);
        });

        break;
      case "noCollectionFound":
        console.log("No collection found");
        break;

      case "collectionsReady":
        console.log("Collections ready!");
        const blobs = [];

        data.forEach(c => {
          var blob = getBlob(c.variables);
          blobs.push( {name: c.name, blob: blob } );
        })

        console.log("Collection count: " + data.length);

        blobs.forEach(b => {
          downloadFile(b.blob, b.name)
        })

        break;
    }
  }

  document.getElementById('export').onclick = () => {
    const selectedCollections = Array.from(document.querySelectorAll('.colCheckbox:checked'))
      .map(checkbox => checkbox.value);
    parent.postMessage({ pluginMessage: { type: 'export-selected-collections', selectedCollections } }, '*');
  }

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }

  function getBlob(textContents) {
    // Join the array elements into a single string with newline characters
    const text = textContents.join('\n');

    // Create a blob with the text content and specify the MIME type
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });

    return blob;
  }

  async function zipFiles(blobs) {
    

    const zip = new JSZip();
    
    blobs.forEach(b => {
      zip.file(b.name + ".scheme", b.blob)
    })

    const zipped = await zip.generateAsync({type: "blob"});
    console.log("Zipping complete!");
    return zipped;
  }

  function downloadFile(file, filename) {
  // Create an anchor element and set the href to the blob URL
    const a = document.createElement('a');
    a.href = URL.createObjectURL(file);
    a.download = filename; // Set the desired file name

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

</script>